<div class="posts-wrapper">
	@if (error(); as err) {
		<div class="error-banner fade-in" role="alert">
			<span>{{ err }}</span>
			<button class="btn mini-btn" (click)="dismissError()" aria-label="Cerrar">√ó</button>
		</div>
	}

	<div class="posts-toolbar">
		<h2 class="h2" style="margin:0 1rem 0 0">Registros</h2>
		<div class="posts-actions">
			<button class="btn" (click)="load()" [disabled]="loading()">‚ü≥ Refrescar</button>
			<button class="btn btn-primary" (click)="openCreate()">Ôºã Nuevo</button>
			<div class="filter-box" style="align-items:flex-end">
				<label style="display:flex; flex-direction:column; font-size:.55rem">
					<span style="margin-bottom:.25rem">Filtrar userId</span>
					  <input style="width:110px" placeholder="ej: 1" [value]="filterUser()" (input)="onFilterUserInput($event)" />
				</label>
				<label style="display:flex; flex-direction:column; font-size:.55rem">
					<span style="margin-bottom:.25rem">Buscar t√≠tulo</span>
					  <input style="width:180px" placeholder="texto..." [value]="searchTerm()" (input)="onSearchTitleInput($event)" />
				</label>
				@if (filterUser() || searchTerm()) {
					<button class="btn mini-btn" (click)="filterUser.set(''); searchTerm.set('')">Limpiar</button>
				}
			</div>
		</div>
	</div>

	@if (loading()) {
		<div class="skeleton-grid" aria-hidden="true">
			@for (item of [0,1,2,3,4,5]; track item) {
				<div class="skeleton-card"></div>
			}
		</div>
	}

	<!-- Backend Posts -->
	<h3 class="divider" style="margin:1.8rem 0 .7rem; color:#fff; font-weight:800; font-size:1.35rem; background:linear-gradient(90deg,#334155 80%,#475569 100%); padding:10px 22px; border-radius:10px; box-shadow:0 2px 12px #33415522; letter-spacing:.5px; display:flex; align-items:center; gap:10px; text-shadow:0 2px 8px #0002;">
		<span style="font-size:1.5em;opacity:.85;vertical-align:middle">üè†</span>
		Tus Registros (Backend)
	</h3>
	@if (!loading() && postsBackend().length === 0) {
		<p class="empty">Sin resultados en backend.</p>
	}
	<ul class="posts-list">
		@for (p of postsBackend(); track p.id) {
			<li class="post-item">
				@if (!(editingId() === p.id) && !(quickEditId() === p.id)) {
					<h3 [title]="'ID '+p.id">{{ p.title }}</h3>
				}
				@if (quickEditId() === p.id && editingId() !== p.id) {
					<div class="quick-edit-row">
						<input [value]="quickTitle()" (input)="onQuickTitleInput($event)" autofocus />
						<button class="btn mini-btn" [disabled]="busyIds().has(p.id!)" (click)="submitQuickTitle(p)">‚úî</button>
						<button class="btn mini-btn" (click)="quickEditId.set(null)">√ó</button>
					</div>
				}
				@if (editingId() === p.id) {
					<div class="inline-edit">
						<input [value]="editForm().title" (input)="onEditTitleInput($event)" />
						<textarea [value]="editForm().body" (input)="onEditBodyInput($event)"></textarea>
					</div>
				}
				@if (editingId() !== p.id) {
					<p>{{ p.body }}</p>
				}
				@if (editingId() === p.id) {
					<p class="muted" style="font-size:.6rem">Editando ID {{ p.id }}</p>
				}
				<footer>
					<span class="chip">user {{ p.userId }}</span>
					<div class="post-actions">
						@if (editingId() !== p.id && quickEditId() !== p.id) {<button class="btn mini-btn" [disabled]="busyIds().has(p.id!)" (click)="patchTitle(p)" title="Editar t√≠tulo r√°pido">‚úé</button>}
						@if (editingId() !== p.id) {<button class="btn mini-btn" [disabled]="busyIds().has(p.id!)" (click)="startEdit(p)" title="Editar completo">‚úö</button>}
						@if (editingId() === p.id) {<button class="btn mini-btn" (click)="submitEdit()" [disabled]="busyIds().has(p.id!)">‚úî</button>}
						@if (editingId() === p.id) {<button class="btn mini-btn" (click)="cancelEdit()">√ó</button>}
						<button class="btn mini-btn" [disabled]="busyIds().has(p.id!)" (click)="confirmDelete(p.id!)" title="Eliminar">üóë</button>
					</div>
				</footer>
			</li>
		}
	</ul>

	<!-- API Posts -->
	<h3 class="divider" style="margin:1.8rem 0 .7rem; color:#fff; font-weight:800; font-size:1.35rem; background:linear-gradient(90deg,#64748b 80%,#94a3b8 100%); padding:10px 22px; border-radius:10px; box-shadow:0 2px 12px #64748b22; letter-spacing:.5px; display:flex; align-items:center; gap:10px; text-shadow:0 2px 8px #0002;">
		<span style="font-size:1.5em;opacity:.85;vertical-align:middle">üåê</span>
		Registros de API Externa
	</h3>
	@if (!loading() && postsApi().length === 0) {
		<p class="empty">Sin resultados en API.</p>
	}
	<ul class="posts-list api-list">
		@for (p of postsApi(); track p.id) {
			<li class="post-item api-item">
				<h3 [title]="'ID '+p.id">{{ p.title }}</h3>
				<p>{{ p.body }}</p>
				<footer>
					<span class="chip">user {{ p.userId }}</span>
					<span class="chip api-chip">API</span>
				</footer>
			</li>
		}
	</ul>

	@if (showOverlay()) {
		<div class="loading-overlay" role="status" aria-live="polite">
			<div class="loader"></div>
			<p>Cargando...</p>
		</div>
	}

	@if (showCreateModal()) {
		<div class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Crear Post">
			<form class="modal create-modal" (submit)="handleCreate($event)">
				<div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
					<h3 style="margin:0;font-size:1.2rem;font-weight:700;letter-spacing:.5px;color:#334155">Nuevo Registro</h3>
					<button type="button" class="btn mini-btn modal-close" (click)="closeCreate()" style="font-size:1.2rem;">√ó</button>
				</div>
				<div class="create-modal-grid" style="display:grid;gap:1.2rem;margin-top:1.2rem;">
					<div class="field-group full">
						<span class="label-text">T√≠tulo</span>
						<input placeholder="T√≠tulo descriptivo" [value]="form().title" (input)="onCreateTitleInput($event)" required autofocus style="font-size:1rem;padding:.5rem .7rem;border-radius:6px;border:1px solid #cbd5e1;" />
						<div class="helper" style="font-size:.7rem;color:#64748b;">M√°x. 120 caracteres (demo, no validado)</div>
					</div>
					<div class="field-group full">
						<span class="label-text">Contenido</span>
						<textarea placeholder="Escribe el cuerpo del post" [value]="form().body" (input)="onCreateBodyInput($event)" required style="font-size:1rem;padding:.5rem .7rem;border-radius:6px;border:1px solid #cbd5e1;"></textarea>
						<div class="helper" style="font-size:.7rem;color:#64748b;">Puedes poner texto libre. JSONPlaceholder simula el guardado.</div>
					</div>
					<div class="field-group" style="max-width:140px">
						<span class="label-text">User ID</span>
						<input type="number" min="1" [value]="form().userId" disabled style="background:#f1f5f9; color:#64748b; font-weight:600; border-radius:6px; border:1px solid #cbd5e1;" />
					</div>
				</div>
				<div class="modal-footer" style="display:flex;justify-content:flex-end;gap:1rem;margin-top:1.5rem;">
					<button type="button" class="btn" (click)="closeCreate()" style="background:#f1f5f9;color:#334155;">Cancelar</button>
					<button class="btn btn-primary" [disabled]="creating()" style="background:#334155;color:#fff;">{{ creating() ? 'Creando...' : 'Guardar' }}</button>
				</div>
			</form>
		</div>
	}

	@if (showDelete() !== null) {
		<div class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Confirmar Eliminaci√≥n">
			<div class="modal">
				<div class="modal-header">
					<h3>Eliminar Post</h3>
					<button type="button" class="btn mini-btn modal-close" (click)="cancelDelete()">√ó</button>
				</div>
				<div class="danger-zone">
					Esta acci√≥n (fake) eliminar√° el post con ID <strong>{{ showDelete() }}</strong> localmente.
				</div>
				<div class="modal-footer">
					<button class="btn" type="button" (click)="cancelDelete()">Cancelar</button>
					<button class="btn btn-danger" type="button" (click)="del(showDelete()!)">Eliminar</button>
				</div>
			</div>
		</div>
	}
</div>
